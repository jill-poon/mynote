# Spring Cloud

## Sentinel

### 什么是Sentinel？

`Sentinel` 是面向微服务架构的**流量治理组件**，主要**从流量为切入点**，提供**流量控制**、**熔断降级**、**系统保护**、**热点参数**、**来源访问等方式**，来为微服务架构应用保证**稳定性**。
  
### Sentinel 有哪些规则？

* 流量控制规则
* 熔断降级规则
* 热点参数规则
* 系统保护规则
* 来源访问控制规则

### 流控模式有哪几种？

* **直接**，直接对该资源进行流量控制。
* **关联**，当关联资源到达阈值时，限流该资源。
* **链路**，对指定资源从入口资源进来的流量，超过指定阈值，则限流。

### 流控手段有哪几种？

* **直接拒绝**，当流量超过规则阈值时，新的请求被直接拒绝，抛出异常。这种方式适合用于对系统处理能力确切已知的情况下，比如通过压测确定了系统准确水位时。
* **冷启动**，主要用于系统长期处于 *低水位* 的情况下，当 ***流量突增*** 时，直接把系统 *拉升* 到 *高水位* 可能瞬间把系统 ***压垮*** 。可以用过冷启动的方式，让通过的流量根据 **`coldFactor`** 缓慢增加到阈值上限，避免系统被压垮。适合秒杀场景。
* **均匀器**，这种方式严格控制请求通过的间隔时间，让请求**匀速**通过。这种策略是**漏桶算法**结合**虚拟队列等待机制**的实现。适用于处理如消息队列这样的**间隔性突发**的流量。

### 什么是熔断降级？(2023年广州花市，公园前地铁站只能出A出口)

在分布式环境中，一个服务通常依赖于另一个服务，当被依赖的服务出现不稳定状况，会导致请求的**响应时间变长**，当前服务的方法响应时间也变长，**工作线程产生堆积**，最终**耗尽业务线程池**，使当前**服务不可用**。那么当多个服务之间相互调用，组成更为**复杂的调用链路**，当某一部分服务不稳定，可能会层层级联，最终导致**整个链路不可用**。需要对**不稳定**的**弱依赖服务调用**进行降级，**暂时切断不稳定调用**，避免**局部不稳定**导致**整体雪崩**。

### 熔断器有哪几种状态？

![slow_request_ratio.png](./images/slow_request_ratio.drawio.png)

* **CLOSED**。正常状态，请求正常通过。当到达熔断规则时，进入*OPENED*。
* **OPENED**。打开状态，拒绝请求。当熔断时长结束后，进入*HALF_OPEN*。
* **HALF_OPEN**。探测恢复状态，如果通过当前策略的结束熔断判断，关闭熔断器(*CLOSED*)；否则，重新变为*OPENED*状态。

### 熔断策略有哪几种？

#### 慢调用

* **慢调用比例**。

> 单位统计时长内请求数大于设置的最小请求数并且**慢调用比例大于设置的阈值**，开启熔断；**下一个请求响应时间小于设置的最大响应时间**，关闭熔断。

#### 异常

* **异常比例**。
* **异常数**。

>单位统计时长内请求数大于设置的最小请求数并且**异常(比例/数)大于阈值**，开启熔断；**下一个请求没有发生异常，关闭熔断。**
