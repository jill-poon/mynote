# Seata

[TOC]

## 1 Seata 是什么？

`Seata` 是阿里开源的分布式事务处理服务。

## 2 Seata 支持事务模式

| 模式     | 业务侵入 | 补偿型 | 依赖数据库 | 性能  |
| :------- | :------: | :----: | :--------: | :---: |
| **AT**   |    ×     |   ○    |     ○      |   M   |
| **TCC**  |    ○     |   ○    |     ×      |   H   |
| **Saga** |    ○     |   ○    |     ×      |   H   |
| **XA**   |    ×     |   ×    |     ○      |   L   |

>**补偿型**：存在中间状态、最终一致性。
>**依赖数据库**：需要依赖本地数据库事务支持。

## 3 Seata 的全局事务处理过程

分为两个阶段

### 3.1 执行阶段 (可回滚, 可持久化)

执行**分支事务**，保证执行结果是**可回滚**和**可持久化的**

### 3.2 完成阶段 (全局提交, 全局回滚)

根据 **执行阶段** 结果形成的决议，应用通过 `TM` 发出的**全局提交或回滚**的请求给 `TC`，`TC` 命令 `RM` 驱动 分支事务 进行 `commit` 或 `rollback`

## 4 事务模式

### 4.1 `AT` 模式

* 基于支持本地 `ACID` 事务的关系型数据库
* 最终一致性
* 异步提交
* 业务非侵入
* 依赖本地数据库事务

> 80%业务使用

执行：

* **一阶段**：
    1. **业务数据和回滚日志记录在同一个本地事务中提交**
    2. **释放本地锁** 和 **连接资源**。
* **二阶段**：
    1. **提交异步化**，非常快速地完成。
    2. 回滚通过一阶段的**回滚日志**进行**反向补偿**。

### 4.2 `XA` 模式

* 强一致性
* 业务非侵入
* 依赖本地数据库支持
* 性能、需要解决**死锁**

> 需要强一致性业务使用

执行：

* **一阶段**：
  
  * 可回滚：业务 `SQL` 操作放在 **`XA` 分支中**进行，由资源对 `XA协议` 的支持来保证可回滚
  * 持久化： **`XA` 分支**完成后，执行 **`XA` prepare** ，同样，由资源对 **`XA`协议** 的支持来**保证持久化**
* **二阶段**：
  * 分支提交：执行 `XA 分支`的 `commit`
  * 分支回滚：执行 `XA 分支`的 `rollback`

#### 4.2.1 为什么 Seata 中支持 `XA` ？

本质上，`Seata` 已经支持的3大事务模式：`AT`、`TCC`、`SAGA` 都是**补偿型**的。
补偿型事务处理机制**构建在 `事务资源` 之上**，`事务资源` 本身**对分布式事务是无感知的**。
`事务资源`对分布式事务的无感知存在一个根本性问题：**无法做到真正的全局一致性**。

### 4.3 TCC 模式

* 不依赖于本地数据库事务
* 整个过程没有锁，性能高
* 最终一致性
* 业务侵入

> 金融业使用较多

* Try：对业务资源检测并预留。
* Confirm：提交。
* Cancel：取消。

执行：

* **一阶段**：
  * 调用 **自定义** `prepare` 逻辑
* **二阶段**：
  * 分支提交：调用 **自定义** `commit` 逻辑
  * 分支回滚：调用 **自定义** `rollback` 逻辑

> 把**自定义**的分支事务纳入到全局事务的管理中。

### 4.4 Saga 模式

* 每个参与者都提交本地事务
* 通常由**事件驱动，异步执行**
* 提供了**异构系统**的事务统一处理模型

> 长事务解决方案

* **一阶段**正向服务和**二阶段**补偿服务 *(执行处理时候出错了，给一个修复的机会)* 都由业务开发实现。

## 5 隔离

### 5.1 写隔离

* 一阶段本地事务提交前，需要确保先拿到 **全局锁** 。
* 拿不到 **全局锁** ，不能提交本地事务。
* 拿 **全局锁** 的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁。

### 5.2 读隔离

* 数据库本地事务隔离级别 **读已提交（Read Committed）** 或以上的基础上, Seata（AT 模式）的默认全局隔离级别是 **读未提交（Read Uncommitted）** 。
* 需要求全局的 **读已提交**，目前 Seata 的方式是通过 `SELECT FOR UPDATE` 语句的代理。
  * `SELECT FOR UPDATE` 语句的执行会申请 **全局锁**。如果 **全局锁** 被其他事务持有，则释放本地锁（回滚 `SELECT FOR UPDATE` 语句的本地执行）并重试。
