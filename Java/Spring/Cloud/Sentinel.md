# Spring Cloud Alibaba

[TOC]

## 1 Sentinel

### 1.1 什么是Sentinel？

`Sentinel` 是面向微服务架构的**流量治理组件**，主要**从流量为切入点**，提供**流量控制**、**熔断降级**、**系统保护**、**热点参数**、**来源访问等方式**，来为微服务架构应用保证**稳定性**。

### 1.2 Sentinel 有哪些规则？

* 流量控制规则
* 熔断降级规则
* 热点参数规则
* 系统保护规则
* 来源访问控制规则

## 2 流量控制规则

### 2.1 阈值类型？

* QPS
* Thread Count

### 2.2 流控模式有哪几种？

* **直接**，直接对该资源进行流量控制。
* **关联**，当关联资源到达阈值时，限流该资源。
* **链路**，对指定资源从入口资源进来的流量，超过指定阈值，则限流。

### 2.3 流控手段有哪几种？

* **直接拒绝**，当流量超过规则阈值时，新的请求被直接拒绝，抛出异常。这种方式适合用于对系统处理能力确切已知的情况下，比如通过压测确定了系统准确水位时。
* **冷启动**，主要用于系统长期处于 *低水位* 的情况下，当 ***流量突增*** 时，直接把系统 *拉升* 到 *高水位* 可能瞬间把系统 ***压垮*** 。可以用过冷启动的方式，让通过的流量根据 **`coldFactor`** 缓慢增加到阈值上限，避免系统被压垮。使用 **[动态速率令牌桶算法](../../../Algorithm/TokenBucket.md)** 实现。适合秒杀场景。
* **均匀器**，这种方式严格控制请求通过的间隔时间，让请求**匀速**通过。这种策略是 **[漏桶算法](../../../Algorithm/LeakyBucket.md)** 结合**虚拟队列等待机制 (最大队列时间+sleep)**的实现。适用于处理如消息队列这样的**间隔性突发**的流量。

## 3 熔断降级规则

### 3.1 什么是熔断降级？(2023年广州花市，公园前地铁站只能出A出口)

在分布式环境中，一个服务通常依赖于另一个服务，当被依赖的服务出现不稳定状况，会导致请求的**响应时间变长**，当前服务的方法响应时间也变长，**工作线程产生堆积**，最终**耗尽业务线程池**，使当前**服务不可用**。那么当多个服务之间相互调用，组成更为**复杂的调用链路**，当某一部分服务不稳定，可能会层层级联，最终导致**整个链路不可用**。需要对**不稳定**的**弱依赖服务调用**进行降级，**暂时切断不稳定调用**，避免**局部不稳定**导致**整体雪崩**。

### 3.2 熔断器有哪几种状态？

![slow_request_ratio.png](./images/slow_request_ratio.drawio.png)

* **CLOSED**。正常状态，请求正常通过。当到达熔断规则时，进入*OPENED*。
* **OPENED**。打开状态，拒绝请求。当熔断时长结束后，进入*HALF_OPEN*。
* **HALF_OPEN**。探测恢复状态，当下一个请求满足当前策略的结束熔断条件，关闭熔断器(*CLOSED*)；否则，再次设置为*OPENED*状态。

### 3.3 熔断策略有哪几种？

#### 3.3.1 响应时间熔断器

* **慢调用比例**

> 单位统计时长内请求数大于设置的最小请求数并且**慢调用比例大于设置的阈值**，开启熔断；**下一个请求响应时间小于设置的最大响应时间**，关闭熔断。

#### 3.3.2 异常熔断器

* **异常比例**。
* **异常数**。

>单位统计时长内请求数大于设置的最小请求数并且**异常(比例/数)大于阈值**，开启熔断；**下一个请求没有发生异常，关闭熔断。**

## 4 核心类

### 4.1 什么是 `Context`, `Entry`, `Node` ？

* **`Context`**：代表**调用链路的上下文**，贯穿依次调用链路中所有的 `Entry`。`Context` 会以 **`ThreadLocal`** 传递的方式，维持着 **`entranceNode`**, **`curEntry`**, **调用来源** 等信息。
* **`Entry`**：每次资源调用**都会创建一个 `Entry`** , `Entry` 实例维护着 **资源名称**，**curNode**，**originNode** 等信息。
* **`Node`**：`Sentinel` 里面的**统计节点**

### 4.2 什么是, `Slot Chain` ？(7)

在 `Sentinel` 里面，每次资源调用都会创建一个 `Entry`，每一个 `Entry` 创建的时候，同时会创建一系列的 **`slot chain`**，每个 `slot` 有不同的职责，通过**责任链**的方式，来完成限流、降级等操作。

在默认的情况下，`Sentinel` 会创建：

1. **NodeSelectorSlot**，负责**收集资源路径**，以**树状结构**存储起来，用于根据调用路径来限流降级。
2. **ClusterBuilderSlot**，用于存储**资源统计信息**及**调用者信息**，如 **`RT`** ，**`QPS`**，**`Thread Count`** ，用于作为限流降级依据。
3. **StatisticSlot**，统计 **`runtime`** 信息。
4. **SystemSlot**，用过**系统状态**，控制**总的入口流量**。
5. **AuthoritySlot**，根据**黑白名单**，控制流量。
6. **FlowSlot**，限流。
7. **DegradeSlot**，降级。
  
### 4.3 可以说一下 `Sentinel` 有哪些 `Node` 吗？(4)

* **EntranceNode**：**入口节点**，对应某个 `Context` 入口的所有调用数据。
* **DefaultNode**：**默认节点**，用于**统计调用链路上某个 `Resource` 的数据**，**维持树状结构**。
* **ClusterNode**：**簇节点**，用于统计每个资源全局的数据，以及存放该资源按来源区分的调用数据。
* **StatisticNode**：**统计节点**，包含**秒级**和**分钟级**两个**滑动窗口结构**的节点。

### 4.4 `StatisticNode`

`StatisticNode` 包含了秒级和分钟级两个滑动窗口结构节点。使用 `LeapArray` 数据结构实现，巧妙的利用了**除法取整** *(计算环形数组下标时，利用除法取整原则，保证了一秒内的所有时间搓得到的timeId是相等的；利用求余运算原则，保证一秒内获取到的桶的下标位是一致的)* 和**求余原则** *(计算当前滑动窗口的开始时间时，利用求余运算原则，保证一秒内获取到的桶的开始时间是一致的)* 实现了窗口滑动，滑动窗口根据时间戳顺时针旋转，桶的数量决定了滑动窗口的统计时长，60个桶，统计一分钟的数据，内部是利用并发工具类 **`LongAdder`** 的特性来实现高效的数据统计。

## 5 整合 Sentinel

### 5.1 Sentinel API Gateway Adapter Common

#### 5.1.1 GatewayFlowRule

网关限流规则，针对 API Gateway 的场景定制的限流规则，可以针对不同 route 或自定义的 API 分组进行限流，支持 针对请求中的参数、Header、来源 IP 等进行定制化的限流。

* `GatewayRuleManager.loadRules(rules)` 手动加载网关规则。
* `GatewayRuleManager.register2Property(property)`注册动态规则源推送。**(推荐方式)**

#### 5.1.2 ApiDefinition

用户自定义的 API 定义分组，可以看做是一些 URL 匹配的组合。限流的时候可以针对这个自定义的 API 分组维度进行限流。
